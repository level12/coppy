from pathlib import Path

import nox


package_path = Path.cwd()
nox.options.default_venv_backend = 'uv'


def uv_sync(session, group: str):
    session.run('uv', 'sync', '--active', '--no-default-groups', '--group', group)


@nox.session
def tests(session: nox.Session):
    uv_sync(session, 'tests')
    session.run(
        'pytest',
        '-ra',
        '--tb=native',
        '--strict-markers',
        '--cov',
        '--cov-config=.coveragerc',
        '--cov-report=xml',
        '--no-cov-on-fail',
        f'--junit-xml={package_path}/ci/test-reports/{session.name}.pytests.xml',
        'src/{{py_module}}_tests',
        *session.posargs,
    )


@nox.session
def precommit(session: nox.Session):
    uv_sync(session, 'pre-commit')
    session.run(
        'pre-commit',
        'run',
        '--all-files',
    )


@nox.session
def audit(session: nox.Session):
    # Much faster to install the deps first and have pip-audit run against the venv
    uv_sync(session, 'audit')
    session.run(
        'pip-audit',
        '--desc',
        '--skip-editable',
    )
